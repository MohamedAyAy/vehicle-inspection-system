<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <style>
        /* Theme changed to teal: primary #1abc9c, accent/darker #16a085 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            color: #1abc9c;
            font-size: 28px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        button {
            background: #1abc9c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #16a085;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button.logout {
            background: #ff6b6b;
        }

        button.logout:hover {
            background: #ff5252;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1abc9c;
            box-shadow: 0 0 0 3px rgba(26, 188, 156, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-group button {
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th {
            background: #f5f5f5;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        table tr:hover {
            background: #f9f9f9;
        }

        .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .badge.confirmed {
            background: #d4edda;
            color: #155724;
        }

        .badge.completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge.pass {
            background: #d4edda;
            color: #155724;
        }

        .badge.fail {
            background: #f8d7da;
            color: #721c24;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            border-color: #1abc9c;
        }

        .checkbox-item input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #1abc9c;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #1abc9c;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1abc9c;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .dashboard-grid,
            .form-row,
            .checkbox-group {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                gap: 15px;
            }

            .nav-buttons {
                width: 100%;
            }

            .nav-buttons button {
                flex: 1;
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 24px;
        }

        .user-info {
            font-size: 14px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .badge.confirmed {
            background: #d4edda;
            color: #155724;
        }

        .badge.not_checked {
            background: #e7f3ff;
            color: #004085;
        }

        .badge.in_progress {
            background: #fff3cd;
            color: #856404;
        }

        .badge.passed {
            background: #d4edda;
            color: #155724;
        }

        .badge.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .badge.passed_with_minor_issues {
            background: #fff3cd;
            color: #856404;
        }

        .badge.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge.error {
            background: #f8d7da;
            color: #721c24;
        }

        button:disabled {
            background: #ccc !important;
            cursor: not-allowed;
        }

        button:disabled:hover {
            background: #ccc !important;
            transform: none;
            box-shadow: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .admin-tab {
            min-height: 300px;
        }

        .badge.customer {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge.technician {
            background: #fff3cd;
            color: #856404;
        }

        .badge.admin {
            background: #f8d7da;
            color: #721c24;
        }

        .pagination {
            display: inline-flex;
            gap: 5px;
            align-items: center;
        }

        .pagination button {
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
        }

        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }

        .pagination button:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <header class="main-header" id="mainHeader" style="display: none;">
        <div class="logo">
            <div class="logo-icon">üöó</div>
            <div>
                <h1>Vehicle Inspection Center</h1>
                <div class="user-info" id="userInfo"></div>
            </div>
        </div>
        <div class="nav-buttons">
            <button id="navDashboard" onclick="navigateTo('dashboard')" style="display: none;">Dashboard</button>
            <button id="navAppointments" onclick="navigateTo('appointments')" style="display: none;">Appointments</button>
            <button id="navInspection" onclick="navigateTo('inspection')" style="display: none;">Inspections</button>
            <button id="navAdmin" onclick="navigateTo('admin')" style="display: none;">Admin</button>
            <button class="logout" onclick="logout()">Logout</button>
        </div>
    </header>

    <div class="container">
        <!-- Auth Pages -->
        <div id="loginPage" class="page active">
            <div class="card" style="max-width: 400px; margin: 100px auto;">
                <h2 style="margin-bottom: 30px; text-align: center; color: #667eea;">Login</h2>
                <div id="loginAlert" class="alert"></div>
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <div class="form-group" style="padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px;">
                        <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                            <input type="checkbox" id="loginRecaptcha" required style="width: auto; margin-right: 10px;">
                            <span>I'm not a robot (reCAPTCHA placeholder)</span>
                        </label>
                        <small style="color: #666; margin-top: 5px; display: block;">‚úÖ In production, this will be replaced with Google reCAPTCHA v2</small>
                    </div>
                    <button type="submit" style="width: 100%; margin-bottom: 10px;">Login</button>
                    <button type="button" onclick="navigateTo('register')" style="width: 100%; background: #764ba2;">Create Account</button>
                </form>
            </div>
        </div>

        <div id="registerPage" class="page">
            <div class="card" style="max-width: 600px; margin: 50px auto;">
                <h2 style="margin-bottom: 30px; text-align: center; color: #667eea;">Create Account</h2>
                <div id="registerAlert" class="alert"></div>
                <form onsubmit="handleRegister(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name (Optional)</label>
                            <input type="text" id="registerFirstName" minlength="2" placeholder="John">
                        </div>
                        <div class="form-group">
                            <label>Last Name (Optional)</label>
                            <input type="text" id="registerLastName" minlength="2" placeholder="Doe">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password * (minimum 8 characters)</label>
                        <input type="password" id="registerPassword" required minlength="8">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date of Birth (Optional - Must be 18+ if provided)</label>
                            <input type="date" id="registerBirthdate" max="9999-12-31">
                        </div>
                        <div class="form-group">
                            <label>ID/Passport Number (Optional)</label>
                            <input type="text" id="registerIdNumber" minlength="5" placeholder="e.g., AB123456">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Country (Optional)</label>
                            <input type="text" id="registerCountry" placeholder="e.g., France">
                        </div>
                        <div class="form-group">
                            <label>State/Province (Optional)</label>
                            <input type="text" id="registerState" placeholder="e.g., √éle-de-France">
                        </div>
                    </div>
                    <div class="form-group" style="display: none;">
                        <label>Role</label>
                        <select id="registerRole">
                            <option value="customer" selected>Customer</option>
                        </select>
                    </div>
                    <div class="alert info" style="display: block; margin-bottom: 15px;">
                        ‚ÑπÔ∏è Public registration is for customers only. Technician accounts must be created by an administrator.
                    </div>
                    <div class="form-group" style="padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px;">
                        <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                            <input type="checkbox" id="registerRecaptcha" required style="width: auto; margin-right: 10px;">
                            <span>I'm not a robot (reCAPTCHA placeholder)</span>
                        </label>
                        <small style="color: #666; margin-top: 5px; display: block;">‚úÖ In production, this will be replaced with Google reCAPTCHA v2</small>
                    </div>
                    <button type="submit" style="width: 100%; margin-bottom: 10px;">Register</button>
                    <button type="button" onclick="navigateTo('login')" style="width: 100%; background: #764ba2;">Back to Login</button>
                </form>
            </div>
        </div>

        <!-- Dashboard Pages -->
        <div id="dashboardPage" class="page">
            <div class="card">
                <h2>Dashboard</h2>
                <div id="dashboardContent"></div>
            </div>
        </div>

        <!-- Customer Appointments -->
        <div id="appointmentsPage" class="page">
            <div class="card">
                <h2>Book Appointment</h2>
                <div id="appointmentAlert" class="alert"></div>
                <form onsubmit="handleBookAppointment(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Vehicle Type</label>
                            <select id="vehicleType" required>
                                <option value="">Select Type</option>
                                <option value="car">Car</option>
                                <option value="motorcycle">Motorcycle</option>
                                <option value="truck">Truck</option>
                                <option value="van">Van</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Registration Number</label>
                            <input type="text" id="vehicleReg" placeholder="e.g., AB-123-CD" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Brand</label>
                            <input type="text" id="vehicleBrand" placeholder="e.g., Toyota" required>
                        </div>
                        <div class="form-group">
                            <label>Model</label>
                            <input type="text" id="vehicleModel" placeholder="e.g., Corolla" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Appointment Date</label>
                        <input type="datetime-local" id="appointmentDate">
                    </div>
                    <button type="submit">Book Appointment</button>
                </form>
            </div>

            <div class="card">
                <h2>Your Appointments</h2>
                <div id="appointmentsList"></div>
            </div>
        </div>

        <!-- Technician Inspection -->
        <div id="inspectionPage" class="page">
            <div class="card">
                <h2>Submit Inspection Results</h2>
                <div id="inspectionAlert" class="alert"></div>
                <form onsubmit="handleSubmitInspection(event)">
                    <div class="form-group">
                        <label>Appointment ID</label>
                        <input type="text" id="inspectionAppId" required>
                    </div>

                    <h3 style="margin-top: 25px; margin-bottom: 15px;">Inspection Items</h3>
                    <div class="checkbox-group">
                        <div>
                            <label style="margin-bottom: 10px;">Brakes</label>
                            <div>
                                <div class="checkbox-item">
                                    <input type="radio" name="brakes" value="PASS" required> Pass
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="brakes" value="FAIL"> Fail
                                </div>
                            </div>
                        </div>
                        <div>
                            <label style="margin-bottom: 10px;">Lights</label>
                            <div>
                                <div class="checkbox-item">
                                    <input type="radio" name="lights" value="PASS" required> Pass
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="lights" value="FAIL"> Fail
                                </div>
                            </div>
                        </div>
                        <div>
                            <label style="margin-bottom: 10px;">Tires</label>
                            <div>
                                <div class="checkbox-item">
                                    <input type="radio" name="tires" value="PASS" required> Pass
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="tires" value="FAIL"> Fail
                                </div>
                            </div>
                        </div>
                        <div>
                            <label style="margin-bottom: 10px;">Emissions</label>
                            <div>
                                <div class="checkbox-item">
                                    <input type="radio" name="emissions" value="PASS" required> Pass
                                </div>
                                <div class="checkbox-item">
                                    <input type="radio" name="emissions" value="FAIL"> Fail
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 25px;">
                        <label>Overall Result</label>
                        <select id="finalStatus" required>
                            <option value="">Select Result</option>
                            <option value="passed">Passed</option>
                            <option value="failed">Failed</option>
                            <option value="in_progress">In Progress (Save & Continue Later)</option>
                            <option value="passed_with_minor_issues">Passed with Minor Issues</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="inspectionNotes" rows="4" placeholder="Additional notes..."></textarea>
                    </div>

                    <button type="submit">Submit Inspection</button>
                </form>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminPage" class="page">
            <div class="card">
                <h2>Admin Dashboard</h2>
                
                <!-- Tab Navigation -->
                <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #ddd; padding-bottom: 10px; flex-wrap: wrap;">
                    <button id="tabUsers" onclick="showAdminTab('users')" style="background: #667eea;">üë• Users</button>
                    <button id="tabLogs" onclick="showAdminTab('logs')" style="background: #667eea;">üìã Logs</button>
                    <button id="tabVehicles" onclick="showAdminTab('vehicles')" style="background: #667eea;">üöó Vehicles</button>
                    <button id="tabAppointments" onclick="showAdminTab('appointments')" style="background: #667eea;">üìÖ Appointments</button>
                    <button id="tabSchedule" onclick="showAdminTab('schedule')" style="background: #667eea;">üìÜ Schedule</button>
                </div>
                
                <!-- Users Tab -->
                <div id="adminUsersTab" class="admin-tab">
                    <h3>User Management</h3>
                    <button onclick="showCreateUserModal()" style="margin-bottom: 20px;">‚ûï Create Technician</button>
                    <div id="adminUsersList"></div>
                </div>
                
                <!-- Logs Tab -->
                <div id="adminLogsTab" class="admin-tab" style="display: none;">
                    <h3>System Logs</h3>
                    <div class="stats" id="adminStats"></div>
                    
                    <!-- Search/Filter Section -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
                        <h4 style="margin-top: 0;">üîç Search & Filter</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Search Message</label>
                                <input type="text" id="logSearchInput" placeholder="Search in messages..." 
                                    onkeyup="applyLogFilters()"
                                    style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Filter by Service</label>
                                <select id="logServiceFilter" onchange="applyLogFilters()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">All Services</option>
                                    <option value="AuthService">Auth Service</option>
                                    <option value="AppointmentService">Appointment Service</option>
                                    <option value="PaymentService">Payment Service</option>
                                    <option value="InspectionService">Inspection Service</option>
                                    <option value="LoggingService">Logging Service</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Filter by Level</label>
                                <select id="logLevelFilter" onchange="applyLogFilters()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">All Levels</option>
                                    <option value="INFO">INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="applyLogFilters()" style="margin-top: 15px; padding: 10px 20px;">
                            üîç Apply Filters
                        </button>
                        <button onclick="clearLogFilters()" style="margin-top: 15px; margin-left: 10px; padding: 10px 20px; background: #6c757d;">
                            ‚úñÔ∏è Clear
                        </button>
                    </div>
                    
                    <div id="adminLogs"></div>
                </div>
                
                <!-- Vehicles Tab -->
                <div id="adminVehiclesTab" class="admin-tab" style="display: none;">
                    <h3>All Vehicles</h3>
                    <p style="color: #666; margin-bottom: 20px;">Complete list of all vehicles in the system with their inspection status</p>
                    <div id="adminVehiclesList"></div>
                </div>
                
                <!-- Appointments Tab -->
                <div id="adminAppointmentsTab" class="admin-tab" style="display: none;">
                    <h3>All Appointments</h3>
                    <div id="adminAppointmentsList"></div>
                </div>
                
                <!-- Schedule Tab -->
                <div id="adminScheduleTab" class="admin-tab" style="display: none;">
                    <h3>Weekly Schedule</h3>
                    <p style="color: #666; margin-bottom: 20px;">View the same schedule that customers see for booking appointments</p>
                    <div id="adminScheduleView"></div>
                </div>
            </div>
        </div>

        <!-- Create User Modal -->
        <div id="createUserModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close" onclick="closeCreateUserModal()">&times;</span>
                <h2>Create Technician Account</h2>
                <div id="createUserAlert" class="alert"></div>
                <form onsubmit="handleCreateTechnician(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name (Optional)</label>
                            <input type="text" id="newTechFirstName" minlength="2" placeholder="Jane">
                        </div>
                        <div class="form-group">
                            <label>Last Name (Optional)</label>
                            <input type="text" id="newTechLastName" minlength="2" placeholder="Smith">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="newTechEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password * (minimum 8 characters)</label>
                        <input type="password" id="newTechPassword" required minlength="8">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Date of Birth (Optional)</label>
                            <input type="date" id="newTechBirthdate" max="9999-12-31">
                        </div>
                        <div class="form-group">
                            <label>ID/Passport Number (Optional)</label>
                            <input type="text" id="newTechIdNumber" minlength="5" placeholder="TECH123">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Country (Optional)</label>
                            <input type="text" id="newTechCountry" placeholder="France">
                        </div>
                        <div class="form-group">
                            <label>State/Province (Optional)</label>
                            <input type="text" id="newTechState" placeholder="Paris">
                        </div>
                    </div>
                    <button type="submit" style="width: 100%;">Create Technician</button>
                </form>
            </div>
        </div>

        <!-- Change Role Modal -->
        <div id="changeRoleModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeChangeRoleModal()">&times;</span>
                <h2>Change User Role</h2>
                <div id="changeRoleAlert" class="alert"></div>
                <div id="changeRoleContent"></div>
            </div>
        </div>

        <!-- Payment Modal -->
        <div id="paymentModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closePaymentModal()">&times;</span>
                <h2>üí≥ Payment Required</h2>
                <div id="paymentAlert" class="alert"></div>
                <p>Inspection fee: <strong>$50.00</strong></p>
                <p style="margin-bottom: 20px;">Appointment ID: <span id="paymentAppointmentId"></span></p>
                <div class="alert info" style="display: block; margin-bottom: 15px;">
                    ‚ÑπÔ∏è This is a simulated payment for educational purposes only. No real money will be charged.
                </div>
                <button onclick="processPayment()" style="width: 100%;">‚úÖ Confirm Payment (Simulated)</button>
            </div>
        </div>
    </div>

    <script>
        // ============= API CONFIGURATION =============
        const API_BASE = 'http://localhost';
        const SERVICES = {
            auth: `${API_BASE}:8001`,
            appointment: `${API_BASE}:8002`,
            payment: `${API_BASE}:8003`,
            inspection: `${API_BASE}:8004`,
            logging: `${API_BASE}:8005`,
            notification: `${API_BASE}:8006`,
            file: `${API_BASE}:8007`
        };

        let currentUser = null;
        let currentToken = null;

        // ============= PAGE NAVIGATION =============
        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const pageEl = document.getElementById(page + 'Page');
            if (pageEl) {
                pageEl.classList.add('active');
                
                // Load page-specific data
                if (page === 'appointments' && currentUser?.role === 'customer') {
                    loadAppointments();
                } else if (page === 'admin' && currentUser?.role === 'admin') {
                    loadAdminDash();
                } else if (page === 'dashboard') {
                    loadDashboard();
                }
            }
        }

        // ============= AUTHENTICATION =============
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const alert = document.getElementById('loginAlert');

            try {
                const response = await fetch(`${SERVICES.auth}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    showAlert(alert, data.detail || 'Login failed', 'error');
                    return;
                }

                currentToken = data.access_token;
                currentUser = data.user;
                localStorage.setItem('token', currentToken);
                localStorage.setItem('user', JSON.stringify(currentUser));

                showAlert(alert, 'Login successful!', 'success');
                setupUI();
                setTimeout(() => navigateTo('dashboard'), 1000);
            } catch (error) {
                showAlert(alert, 'Connection error: ' + error.message, 'error');
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const role = document.getElementById('registerRole').value;
            const firstName = document.getElementById('registerFirstName').value;
            const lastName = document.getElementById('registerLastName').value;
            const birthdate = document.getElementById('registerBirthdate').value;
            const country = document.getElementById('registerCountry').value;
            const state = document.getElementById('registerState').value;
            const idNumber = document.getElementById('registerIdNumber').value;
            const alert = document.getElementById('registerAlert');

            try {
                const response = await fetch(`${SERVICES.auth}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email, 
                        password, 
                        role,
                        first_name: firstName,
                        last_name: lastName,
                        birthdate,
                        country,
                        state,
                        id_number: idNumber
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    showAlert(alert, data.detail || 'Registration failed', 'error');
                    return;
                }

                showAlert(alert, 'Registration successful! Logging in...', 'success');
                setTimeout(() => {
                    document.getElementById('loginEmail').value = email;
                    document.getElementById('loginPassword').value = password;
                    handleLogin(new Event('submit'));
                }, 1000);
            } catch (error) {
                showAlert(alert, 'Connection error: ' + error.message, 'error');
            }
        }

        function logout() {
            currentUser = null;
            currentToken = null;
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            document.getElementById('mainHeader').style.display = 'none';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            navigateTo('login');
        }

        // ============= UI SETUP =============
        function setupUI() {
            if (!currentUser) {
                document.getElementById('mainHeader').style.display = 'none';
                return;
            }

            document.getElementById('mainHeader').style.display = 'flex';
            document.getElementById('userInfo').textContent = `${currentUser.email} (${currentUser.role})`;

            // Show role-specific buttons
            document.getElementById('navDashboard').style.display = currentUser.role !== 'admin' ? 'block' : 'none';
            document.getElementById('navAppointments').style.display = currentUser.role === 'customer' ? 'block' : 'none';
            document.getElementById('navInspection').style.display = currentUser.role === 'technician' ? 'block' : 'none';
            document.getElementById('navAdmin').style.display = currentUser.role === 'admin' ? 'block' : 'none';
        }

        function showAlert(element, message, type) {
            element.textContent = message;
            element.className = `alert ${type}`;
            element.style.display = 'block';
            setTimeout(() => element.style.display = 'none', 5000);
        }

        // ============= APPOINTMENTS =============
        async function handleBookAppointment(event) {
            event.preventDefault();
            const alert = document.getElementById('appointmentAlert');

            const data = {
                vehicle_type: document.getElementById('vehicleType').value,
                vehicle_registration: document.getElementById('vehicleReg').value,
                vehicle_brand: document.getElementById('vehicleBrand').value,
                vehicle_model: document.getElementById('vehicleModel').value,
                appointment_date: document.getElementById('appointmentDate').value
            };

            try {
                const response = await fetch(`${SERVICES.appointment}/appointments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert(alert, 'Appointment booked successfully!', 'success');
                    event.target.reset();
                    setTimeout(loadAppointments, 1000);
                } else {
                    const error = await response.json();
                    showAlert(alert, error.detail || 'Failed to book appointment', 'error');
                }
            } catch (error) {
                showAlert(alert, 'Error: ' + error.message, 'error');
            }
        }

        async function loadAppointments() {
            try {
                const response = await fetch(
                    `${SERVICES.appointment}/appointments/${currentUser.id}`,
                    {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    }
                );

                const appointments = await response.json();
                const list = document.getElementById('appointmentsList');

                if (appointments.length === 0) {
                    list.innerHTML = '<p>No appointments yet.</p>';
                    return;
                }

                list.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Vehicle</th>
                                <th>Registration</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${appointments.map(apt => `
                                <tr>
                                    <td>${apt.vehicle_info.brand} ${apt.vehicle_info.model}</td>
                                    <td>${apt.vehicle_info.registration}</td>
                                    <td>${apt.appointment_date ? new Date(apt.appointment_date).toLocaleString() : new Date(apt.created_at).toLocaleDateString()}</td>
                                    <td><span class="badge ${apt.status}">${apt.status}</span></td>
                                    <td>
                                        ${apt.status === 'pending' ? 
                                            `<button onclick="showPaymentModal('${apt.id}')">üí≥ Pay Now</button>` : 
                                            apt.status === 'confirmed' ? 
                                            '<span style="color: green;">‚úì Paid & Confirmed</span>' :
                                            '<span>-</span>'
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error loading appointments:', error);
            }
        }

        // ============= INSPECTION =============
        async function handleSubmitInspection(event) {
            event.preventDefault();
            const alert = document.getElementById('inspectionAlert');

            const results = {
                brakes: document.querySelector('input[name="brakes"]:checked').value,
                lights: document.querySelector('input[name="lights"]:checked').value,
                tires: document.querySelector('input[name="tires"]:checked').value,
                emissions: document.querySelector('input[name="emissions"]:checked').value
            };

            const data = {
                appointment_id: document.getElementById('inspectionAppId').value,
                results: results,
                final_status: document.getElementById('finalStatus').value,
                notes: document.getElementById('inspectionNotes').value
            };

            try {
                const response = await fetch(`${SERVICES.inspection}/inspections/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert(alert, 'Inspection submitted successfully!', 'success');
                    event.target.reset();
                } else {
                    const error = await response.json();
                    showAlert(alert, error.detail || 'Failed to submit inspection', 'error');
                }
            } catch (error) {
                showAlert(alert, 'Error: ' + error.message, 'error');
            }
        }

        // ============= ADMIN =============
        let currentAdminTab = 'users';
        
        function showAdminTab(tab) {
            currentAdminTab = tab;
            
            // Hide all tabs
            document.querySelectorAll('.admin-tab').forEach(t => t.style.display = 'none');
            
            // Reset button styles
            document.querySelectorAll('[id^="tab"]').forEach(btn => {
                btn.style.background = '#667eea';
            });
            
            // Show selected tab and highlight button
            document.getElementById(`admin${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`).style.display = 'block';
            document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).style.background = '#764ba2';
            
            // Load content
            if (tab === 'users') {
                loadAdminUsers();
            } else if (tab === 'logs') {
                loadAdminLogs();
            } else if (tab === 'vehicles') {
                loadAdminVehicles();
            } else if (tab === 'appointments') {
                loadAdminAppointments();
            } else if (tab === 'schedule') {
                loadAdminSchedule();
            }
        }
        
        async function loadAdminDash() {
            // Load users tab by default
            showAdminTab('users');
        }
        
        async function loadAdminUsers() {
            const container = document.getElementById('adminUsersList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const response = await fetch(`${SERVICES.auth}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                const users = await response.json();
                
                if (users.length > 0) {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr>
                                        <td><strong>${user.email}</strong></td>
                                        <td><span class="badge ${user.role}">${user.role}</span></td>
                                        <td><small>${new Date(user.created_at).toLocaleDateString()}</small></td>
                                        <td>
                                            <button onclick="showChangeRoleModal('${user.id}', '${user.email}', '${user.role}')" style="padding: 5px 10px; font-size: 12px;">Change Role</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p>No users found.</p>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                container.innerHTML = `<p style="color: red;">Error loading users: ${error.message}</p>`;
            }
        }
        
        let allLogs = []; // Store all logs for filtering
        let filteredLogs = []; // Store filtered logs for pagination
        let currentPage = 1;
        const logsPerPage = 30;
        
        async function loadAdminLogs() {
            const statsDiv = document.getElementById('adminStats');
            const logsDiv = document.getElementById('adminLogs');
            
            statsDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            logsDiv.innerHTML = '';
            
            try {
                const logsResponse = await fetch(`${SERVICES.logging}/log/all?limit=500`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                const logs = await logsResponse.json();
                allLogs = logs; // Store for filtering
                filteredLogs = logs; // Initially, all logs
                currentPage = 1; // Reset to page 1
                
                renderLogs(filteredLogs);
            } catch (error) {
                statsDiv.innerHTML = `<p style="color: red;">Error loading logs: ${error.message}</p>`;
                console.error('Error loading logs:', error);
            }
        }
        
        function renderLogs(logs) {
            const statsDiv = document.getElementById('adminStats');
            const logsDiv = document.getElementById('adminLogs');
            
            filteredLogs = logs; // Update filtered logs for pagination
            
            const stats = {
                total: logs.length,
                info: logs.filter(l => l.level === 'INFO').length,
                warning: logs.filter(l => l.level === 'WARNING').length,
                error: logs.filter(l => l.level === 'ERROR').length
            };
            
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <h3>${stats.total}</h3>
                    <p>Total Logs</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.info}</h3>
                    <p>Info</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.warning}</h3>
                    <p>Warnings</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.error}</h3>
                    <p>Errors</p>
                </div>
            `;
            
            if (logs.length > 0) {
                const totalPages = Math.ceil(logs.length / logsPerPage);
                const startIndex = (currentPage - 1) * logsPerPage;
                const endIndex = startIndex + logsPerPage;
                const currentLogs = logs.slice(startIndex, endIndex);
                
                logsDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <p><strong>Showing ${startIndex + 1}-${Math.min(endIndex, logs.length)} of ${logs.length} log${logs.length !== 1 ? 's' : ''}</strong></p>
                        ${totalPages > 1 ? `
                            <div class="pagination">
                                <button onclick="goToLogPage(1)" ${currentPage === 1 ? 'disabled' : ''}>&laquo; First</button>
                                <button onclick="goToLogPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lsaquo; Prev</button>
                                <span style="margin: 0 15px;">Page ${currentPage} of ${totalPages}</span>
                                <button onclick="goToLogPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next &rsaquo;</button>
                                <button onclick="goToLogPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>Last &raquo;</button>
                            </div>
                        ` : ''}
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Event</th>
                                <th>Level</th>
                                <th>Message</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentLogs.map(log => `
                                <tr>
                                    <td><strong>${log.service}</strong></td>
                                    <td>${log.event}</td>
                                    <td><span class="badge ${log.level.toLowerCase()}">${log.level}</span></td>
                                    <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis;">${log.message}</td>
                                    <td><small>${new Date(log.timestamp).toLocaleString()}</small></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${totalPages > 1 ? `
                        <div class="pagination" style="margin-top: 20px; text-align: center;">
                            <button onclick="goToLogPage(1)" ${currentPage === 1 ? 'disabled' : ''}>&laquo; First</button>
                            <button onclick="goToLogPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lsaquo; Prev</button>
                            <span style="margin: 0 15px;">Page ${currentPage} of ${totalPages}</span>
                            <button onclick="goToLogPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next &rsaquo;</button>
                            <button onclick="goToLogPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>Last &raquo;</button>
                        </div>
                    ` : ''}
                `;
            } else {
                logsDiv.innerHTML = '<p>No logs match the current filters.</p>';
            }
        }
        
        function goToLogPage(page) {
            const totalPages = Math.ceil(filteredLogs.length / logsPerPage);
            if (page < 1) page = 1;
            if (page > totalPages) page = totalPages;
            currentPage = page;
            renderLogs(filteredLogs);
        }
        
        function applyLogFilters() {
            const searchText = document.getElementById('logSearchInput').value.toLowerCase();
            const serviceFilter = document.getElementById('logServiceFilter').value;
            const levelFilter = document.getElementById('logLevelFilter').value;
            
            let filtered = allLogs;
            
            // Apply search filter
            if (searchText) {
                filtered = filtered.filter(log => 
                    log.message.toLowerCase().includes(searchText) ||
                    log.event.toLowerCase().includes(searchText)
                );
            }
            
            // Apply service filter
            if (serviceFilter) {
                filtered = filtered.filter(log => log.service === serviceFilter);
            }
            
            // Apply level filter
            if (levelFilter) {
                filtered = filtered.filter(log => log.level === levelFilter);
            }
            
            currentPage = 1; // Reset to page 1 when filtering
            renderLogs(filtered);
        }
        
        function clearLogFilters() {
            document.getElementById('logSearchInput').value = '';
            document.getElementById('logServiceFilter').value = '';
            document.getElementById('logLevelFilter').value = '';
            currentPage = 1; // Reset to page 1
            renderLogs(allLogs);
        }
        
        async function loadAdminVehicles() {
            const container = document.getElementById('adminVehiclesList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading vehicles...</p></div>';
            
            try {
                // Fetch ALL vehicles from appointments, not just inspected ones
                const response = await fetch(`${SERVICES.appointment}/appointments/admin/all-vehicles?limit=1000`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch vehicles: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.vehicles && data.vehicles.length > 0) {
                    // Calculate statistics
                    const stats = {
                        total: data.vehicles.length,
                        pending: data.vehicles.filter(v => v.status === 'pending').length,
                        confirmed: data.vehicles.filter(v => v.status === 'confirmed').length,
                        not_checked: data.vehicles.filter(v => v.inspection_status === 'not_checked').length,
                        inspected: data.vehicles.filter(v => v.inspection_status !== 'not_checked').length
                    };
                    
                    container.innerHTML = `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                            <p style="margin: 5px 0;"><strong>Total Vehicles:</strong> ${stats.total}</p>
                            <p style="margin: 5px 0;"><strong>Payment Status:</strong> Pending: ${stats.pending}, Confirmed: ${stats.confirmed}</p>
                            <p style="margin: 5px 0;"><strong>Inspection Status:</strong> Not Checked: ${stats.not_checked}, Inspected: ${stats.inspected}</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Registration</th>
                                    <th>Vehicle</th>
                                    <th>User ID</th>
                                    <th>Appointment Date</th>
                                    <th>Payment Status</th>
                                    <th>Inspection Status</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.vehicles.map(vehicle => `
                                    <tr>
                                        <td><strong>${vehicle.vehicle_info.registration}</strong></td>
                                        <td>${vehicle.vehicle_info.brand} ${vehicle.vehicle_info.model} (${vehicle.vehicle_info.type})</td>
                                        <td><small>${vehicle.user_id}</small></td>
                                        <td><small>${vehicle.appointment_date ? new Date(vehicle.appointment_date).toLocaleString() : 'Not scheduled'}</small></td>
                                        <td><span class="badge ${vehicle.status}">${vehicle.status}</span></td>
                                        <td><span class="badge ${vehicle.inspection_status}">${vehicle.inspection_status.replace('_', ' ')}</span></td>
                                        <td><small>${new Date(vehicle.created_at).toLocaleDateString()}</small></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p>No vehicles found in the system.</p>';
                }
            } catch (error) {
                console.error('Error loading vehicles:', error);
                container.innerHTML = `<p style="color: red;">Error loading vehicles: ${error.message}</p>`;
            }
        }
        
        async function loadAdminAppointments() {
            const container = document.getElementById('adminAppointmentsList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const response = await fetch(`${SERVICES.appointment}/appointments/all`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    throw new Error(errorData.detail || `Server returned ${response.status}`);
                }
                
                const appointments = await response.json();
                
                if (Array.isArray(appointments) && appointments.length > 0) {
                    container.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Vehicle</th>
                                    <th>Registration</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${appointments.map(apt => `
                                    <tr>
                                        <td><small>${apt.user_id}</small></td>
                                        <td>${apt.vehicle_info.brand} ${apt.vehicle_info.model}</td>
                                        <td><strong>${apt.vehicle_info.registration}</strong></td>
                                        <td><small>${apt.appointment_date ? new Date(apt.appointment_date).toLocaleString() : 'Not scheduled'}</small></td>
                                        <td><span class="badge ${apt.status}">${apt.status}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p>No appointments found.</p>';
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
                container.innerHTML = `<p style="color: red;">Error loading appointments: ${error.message}</p>`;
            }
        }
        
        async function loadAdminSchedule() {
            const container = document.getElementById('adminScheduleView');
            const today = new Date();
            const dayOfWeek = today.getDay() || 7;
            const monday = new Date(today);
            monday.setDate(today.getDate() - dayOfWeek + 1);
            const startDate = monday.toISOString().split('T')[0];
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading schedule...</p></div>';
            
            try {
                const response = await fetch(
                    `${SERVICES.appointment}/appointments/weekly-schedule?start_date=${startDate}`,
                    { headers: { 'Authorization': `Bearer ${currentToken}` }}
                );
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    throw new Error(errorData.detail || `Server error: ${response.status}`);
                }
                
                const schedule = await response.json();
                
                if (!schedule || !schedule.days || !Array.isArray(schedule.days)) {
                    throw new Error('Invalid schedule data received from server');
                }
                
                // Generate schedule view for admin
                container.innerHTML = `
                    <h4>üìÖ Current Week Schedule</h4>
                    <p style="margin-bottom: 20px; color: #666;">Working hours: ${schedule.working_hours}</p>
                    
                    <div style="overflow-x: auto;">
                        <table style="min-width: 100%;">
                            <thead>
                                <tr>
                                    ${schedule.days.map(day => `
                                        <th style="text-align: center;">
                                            <strong>${day.day_name}</strong><br/>
                                            <small>${new Date(day.date).toLocaleDateString()}</small><br/>
                                            <span style="color: #4caf50; font-size: 12px;">${day.available_count} available</span>
                                        </th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${generateAdminScheduleGrid(schedule)}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 5px;">
                        <p style="margin: 0; color: #2e7d32;"><strong>Legend:</strong></p>
                        <p style="margin: 5px 0; color: #2e7d32;">üü¢ Available slot | üî¥ Booked slot</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading admin schedule:', error);
                container.innerHTML = `
                    <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px;">
                        <h4 style="color: #856404; margin-top: 0;">‚ö†Ô∏è Unable to Load Schedule</h4>
                        <p style="color: #856404;"><strong>Error:</strong> ${error.message}</p>
                        <button onclick="loadAdminSchedule()" style="margin-top: 10px;">üîÑ Retry</button>
                    </div>
                `;
            }
        }
        
        function generateAdminScheduleGrid(schedule) {
            if (!schedule.days || schedule.days.length === 0) return '<tr><td colspan="7" style="text-align: center;">No data</td></tr>';
            
            // Show all slots (available and booked) for admin view
            let html = '<tr>';
            
            schedule.days.forEach(day => {
                html += '<td style="vertical-align: top; padding: 15px;">';
                
                if (day.slots && day.slots.length > 0) {
                    day.slots.forEach(slot => {
                        const bgColor = slot.available ? '#e8f5e9' : '#ffebee';
                        const borderColor = slot.available ? '#4caf50' : '#f44336';
                        const icon = slot.available ? 'üü¢' : 'üî¥';
                        
                        html += `
                            <div style="
                                background: ${bgColor};
                                border: 1px solid ${borderColor};
                                padding: 6px 10px;
                                margin-bottom: 6px;
                                border-radius: 4px;
                                text-align: center;
                                font-size: 13px;
                            ">
                                ${icon} ${slot.display}
                            </div>
                        `;
                    });
                } else {
                    html += '<div style="color: #999; text-align: center; padding: 20px;">No slots</div>';
                }
                
                html += '</td>';
            });
            
            html += '</tr>';
            return html;
        }
        
        // User Management Modals
        function showCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'block';
        }
        
        function closeCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'none';
            document.getElementById('newTechEmail').value = '';
            document.getElementById('newTechPassword').value = '';
            document.getElementById('newTechFirstName').value = '';
            document.getElementById('newTechLastName').value = '';
            document.getElementById('newTechBirthdate').value = '';
            document.getElementById('newTechCountry').value = '';
            document.getElementById('newTechState').value = '';
            document.getElementById('newTechIdNumber').value = '';
        }
        
        async function handleCreateTechnician(event) {
            event.preventDefault();
            const alert = document.getElementById('createUserAlert');
            
            const email = document.getElementById('newTechEmail').value;
            const password = document.getElementById('newTechPassword').value;
            const firstName = document.getElementById('newTechFirstName').value;
            const lastName = document.getElementById('newTechLastName').value;
            const birthdate = document.getElementById('newTechBirthdate').value;
            const country = document.getElementById('newTechCountry').value;
            const state = document.getElementById('newTechState').value;
            const idNumber = document.getElementById('newTechIdNumber').value;
            
            try {
                const response = await fetch(`${SERVICES.auth}/admin/users/create-technician`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ 
                        email, 
                        password,
                        first_name: firstName,
                        last_name: lastName,
                        birthdate,
                        country,
                        state,
                        id_number: idNumber
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert(alert, '‚úÖ Technician created successfully!', 'success');
                    setTimeout(() => {
                        closeCreateUserModal();
                        loadAdminUsers();
                    }, 2000);
                } else {
                    showAlert(alert, data.detail || 'Failed to create technician', 'error');
                }
            } catch (error) {
                showAlert(alert, 'Error: ' + error.message, 'error');
            }
        }
        
        function showChangeRoleModal(userId, email, currentRole) {
            const content = document.getElementById('changeRoleContent');
            const newRole = currentRole === 'customer' ? 'technician' : 'customer';
            
            content.innerHTML = `
                <p><strong>User:</strong> ${email}</p>
                <p><strong>Current Role:</strong> <span class="badge ${currentRole}">${currentRole}</span></p>
                <p style="margin: 20px 0;">Change role to: <span class="badge ${newRole}">${newRole}</span></p>
                <button onclick="changeUserRole('${userId}', '${newRole}')" style="width: 100%;">Confirm Change</button>
            `;
            
            document.getElementById('changeRoleModal').style.display = 'block';
        }
        
        function closeChangeRoleModal() {
            document.getElementById('changeRoleModal').style.display = 'none';
        }
        
        async function changeUserRole(userId, newRole) {
            const alert = document.getElementById('changeRoleAlert');
            
            try {
                const response = await fetch(`${SERVICES.auth}/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ role: newRole })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert(alert, '‚úÖ Role changed successfully!', 'success');
                    setTimeout(() => {
                        closeChangeRoleModal();
                        loadAdminUsers();
                    }, 2000);
                } else {
                    showAlert(alert, data.detail || 'Failed to change role', 'error');
                }
            } catch (error) {
                showAlert(alert, 'Error: ' + error.message, 'error');
            }
        }

        // ============= DASHBOARD =============
        async function loadDashboard() {
            const content = document.getElementById('dashboardContent');
            
            if (currentUser.role === 'customer') {
                loadCustomerDashboard();
            } else if (currentUser.role === 'technician') {
                loadTechnicianVehicles();
            }
        }

        async function loadCustomerDashboard() {
            const content = document.getElementById('dashboardContent');
            const today = new Date();
            const dayOfWeek = today.getDay() || 7;
            const monday = new Date(today);
            monday.setDate(today.getDate() - dayOfWeek + 1);
            const startDate = monday.toISOString().split('T')[0];
            
            content.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading schedule...</p></div>';
            
            try {
                const response = await fetch(
                    `${SERVICES.appointment}/appointments/weekly-schedule?start_date=${startDate}`,
                    { headers: { 'Authorization': `Bearer ${currentToken}` }}
                );
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    console.error('Schedule API error:', errorData);
                    throw new Error(errorData.detail || `Server error: ${response.status}`);
                }
                
                const schedule = await response.json();
                console.log('Schedule loaded:', schedule);
                
                // Check if schedule has proper structure
                if (!schedule || !schedule.days || !Array.isArray(schedule.days)) {
                    console.error('Invalid schedule structure:', schedule);
                    throw new Error('Invalid schedule data received from server');
                }
                
                // Generate schedule showing only available slots (like French CT website)
                content.innerHTML = `
                    <h2>üìÖ Available Inspection Slots This Week</h2>
                    <p style="margin-bottom: 20px;">Working hours: ${schedule.working_hours} | Click on a slot to book</p>
                    
                    <div style="overflow-x: auto;">
                        <table style="min-width: 100%;">
                            <thead>
                                <tr>
                                    ${schedule.days.map(day => `
                                        <th style="text-align: center;">
                                            <strong>${day.day_name}</strong><br/>
                                            <small>${new Date(day.date).toLocaleDateString()}</small>
                                        </th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${generateAvailableSlotsGrid(schedule)}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button onclick="navigateTo('appointments')" style="padding: 15px 30px; font-size: 16px;">
                            üìã Book New Appointment
                        </button>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading schedule:', error);
                content.innerHTML = `
                    <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px;">
                        <h3 style="color: #856404; margin-top: 0;">‚ö†Ô∏è Unable to Load Schedule</h3>
                        <p style="color: #856404;"><strong>Error:</strong> ${error.message}</p>
                        <p style="color: #666;">Please check:</p>
                        <ul style="color: #666;">
                            <li>The appointment service is running on port 8002</li>
                            <li>You have a valid authentication token</li>
                            <li>Your internet connection is stable</li>
                        </ul>
                        <button onclick="loadCustomerDashboard()" style="margin-top: 10px;">üîÑ Retry</button>
                        <p style="margin-top: 15px; font-size: 12px; color: #999;">Check browser console (F12) for detailed error information.</p>
                    </div>
                `;
            }
        }

        function generateAvailableSlotsGrid(schedule) {
            if (!schedule.days || schedule.days.length === 0) return '<tr><td colspan="7" style="text-align: center;">No data</td></tr>';
            
            // Only show available slots for each day (like French CT website)
            let html = '<tr>';
            
            schedule.days.forEach(day => {
                const availableSlots = day.slots.filter(s => s.available);
                
                html += '<td style="vertical-align: top; padding: 15px;">';
                
                if (availableSlots.length > 0) {
                    availableSlots.forEach(slot => {
                        html += `
                            <div style="
                                background: #e8f5e9;
                                border: 1px solid #4caf50;
                                padding: 8px 12px;
                                margin-bottom: 8px;
                                border-radius: 5px;
                                text-align: center;
                                cursor: pointer;
                                font-weight: 500;
                            " 
                            onclick="selectTimeSlot('${slot.time}')">
                                ${slot.display}
                            </div>
                        `;
                    });
                } else {
                    html += '<div style="color: #999; text-align: center; padding: 20px;">No slots</div>';
                }
                
                html += '</td>';
            });
            
            html += '</tr>';
            return html;
        }
        
        function selectTimeSlot(slotTime) {
            // Pre-fill the appointment form with selected time
            const dateInput = document.getElementById('appointmentDate');
            if (dateInput) {
                dateInput.value = slotTime;
            }
            navigateTo('appointments');
        }

        async function loadTechnicianVehicles() {
            const content = document.getElementById('dashboardContent');
            content.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading vehicles...</p></div>';
            
            try {
                const response = await fetch(`${SERVICES.inspection}/inspections/vehicles-for-inspection`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                const data = await response.json();
                
                if (data.vehicles && data.vehicles.length > 0) {
                    content.innerHTML = `
                        <h2>üöó All Vehicles for Inspection</h2>
                        <p style="margin-bottom: 20px;">Total: <strong>${data.total_count}</strong> vehicles | Not Checked: <strong>${data.by_status.not_checked}</strong> | In Progress: <strong>${data.by_status.in_progress}</strong></p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Registration</th>
                                    <th>Vehicle</th>
                                    <th>Appointment Time</th>
                                    <th>Payment Status</th>
                                    <th>Inspection Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.vehicles.map(v => `
                                    <tr>
                                        <td><strong>${v.vehicle_info.registration}</strong></td>
                                        <td>${v.vehicle_info.brand} ${v.vehicle_info.model} (${v.vehicle_info.type})</td>
                                        <td>${v.appointment_time}</td>
                                        <td>${v.payment_status_display || '‚è≥ Pending'}</td>
                                        <td><span class="badge ${v.status}">${v.status_display}</span></td>
                                        <td>
                                            ${v.status === 'not_checked' || v.status === 'in_progress' ? 
                                                `<button onclick="startInspection('${v.appointment_id}')">Inspect</button>` : 
                                                `<button disabled>Completed</button>`
                                            }
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    content.innerHTML = '<p>No vehicles for inspection yet.</p>';
                }
            } catch (error) {
                content.innerHTML = `<p style="color: red;">Error loading vehicles: ${error.message}</p>`;
            }
        }

        function startInspection(appointmentId) {
            document.getElementById('inspectionAppId').value = appointmentId;
            navigateTo('inspection');
        }

        // ============= PAYMENT =============
        let currentPaymentAppointmentId = null;

        function showPaymentModal(appointmentId) {
            currentPaymentAppointmentId = appointmentId;
            document.getElementById('paymentAppointmentId').textContent = appointmentId;
            document.getElementById('paymentModal').style.display = 'block';
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            currentPaymentAppointmentId = null;
        }

        async function processPayment() {
            const alert = document.getElementById('paymentAlert');
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Processing...';
            
            try {
                // Check if payment service is available
                console.log('Initiating payment for appointment:', currentPaymentAppointmentId);
                
                // Create payment
                const createResponse = await fetch(`${SERVICES.payment}/payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        appointment_id: currentPaymentAppointmentId,
                        amount: 50.00
                    })
                });
                
                const createData = await createResponse.json();
                console.log('‚úì Payment creation response:', createResponse.status, createData);
                
                if (!createResponse.ok) {
                    const errorMsg = createData.detail || `Payment creation failed (${createResponse.status})`;
                    console.error('Payment creation error:', errorMsg);
                    showAlert(alert, errorMsg, 'error');
                    btn.disabled = false;
                    btn.textContent = '‚úÖ Confirm Payment (Simulated)';
                    return;
                }
                
                console.log('‚úì Payment created, confirming...');
                
                // Confirm payment (simulated)
                const confirmResponse = await fetch(
                    `${SERVICES.payment}/payment/${createData.id}/confirm-simulated`,
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    }
                );
                
                const confirmData = await confirmResponse.json();
                console.log('‚úì Payment confirmation response:', confirmResponse.status, confirmData);
                
                if (confirmResponse.ok) {
                    console.log('‚úì Payment confirmed successfully!');
                    showAlert(alert, '‚úÖ Payment successful! Appointment confirmed.', 'success');
                    setTimeout(() => {
                        closePaymentModal();
                        if (currentUser.role === 'customer') {
                            loadAppointments();
                        }
                    }, 2000);
                } else {
                    const errorMsg = confirmData.detail || `Payment confirmation failed (${confirmResponse.status})`;
                    console.error('Payment confirmation error:', errorMsg);
                    showAlert(alert, errorMsg, 'error');
                    btn.disabled = false;
                    btn.textContent = '‚úÖ Confirm Payment (Simulated)';
                }
            } catch (error) {
                console.error('‚ùå Payment error:', error);
                const errorMsg = error.message.includes('Failed to fetch') 
                    ? 'Cannot connect to payment service. Please ensure all services are running.' 
                    : error.message;
                showAlert(alert, 'Error: ' + errorMsg, 'error');
                btn.disabled = false;
                btn.textContent = '‚úÖ Confirm Payment (Simulated)';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('paymentModal');
            if (event.target == modal) {
                closePaymentModal();
            }
        }

        // ============= INITIALIZATION =============
        window.addEventListener('load', async () => {
            const savedToken = localStorage.getItem('token');
            const savedUser = localStorage.getItem('user');

            if (savedToken && savedUser) {
                // Verify token is still valid
                try {
                    const response = await fetch(`${SERVICES.auth}/verify`, {
                        headers: { 'Authorization': `Bearer ${savedToken}` }
                    });
                    
                    if (response.ok) {
                        currentToken = savedToken;
                        currentUser = JSON.parse(savedUser);
                        setupUI();
                        navigateTo('dashboard');
                    } else {
                        // Token invalid, clear and show login
                        console.log('Stored token is invalid, clearing...');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        navigateTo('login');
                    }
                } catch (error) {
                    // If verification fails, clear storage
                    console.log('Error verifying token, clearing...');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    navigateTo('login');
                }
            } else {
                navigateTo('login');
            }
        });
    </script>
</body>
</html>